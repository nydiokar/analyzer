# Security: IPFS Metadata Fetching Vulnerability

**Date Identified**: 2025-01-28  
**Severity**: HIGH  
**Status**: PATCH AVAILABLE - NEEDS IMPLEMENTATION  
**Affected Component**: `src/core/services/onchain-metadata.service.ts`

---

## Current Situation

The system fetches token metadata from IPFS/Arweave URIs without security protections. Observed behavior shows:

1. **Suspicious URIs being fetched**:
   - `https://eu.j7tracker.com/metadata/t0qarcfecnguiagm.json`
   - `http://95.179.167.134:3000/metadata/YWKUMA` (IP address, HTTP)
   - `https://rapidlaunch.io/temp/metadata/2a957b3f-f4f3-4a95-94e1-58934e0ac5bd.json`

2. **No validation**: System accepts any URI format, including:
   - Direct IP addresses (potential SSRF risk)
   - HTTP (non-encrypted) endpoints
   - Private network addresses
   - Suspicious hostnames

3. **No size limits**: Response data is accumulated without size checks, allowing:
   - Memory exhaustion attacks (DoS)
   - Large file downloads consuming server resources

4. **No sanitization**: Parsed JSON is used directly without:
   - Prototype pollution protection
   - Depth limits (stack overflow risk)
   - Type validation
   - Content-Type verification

---

## Identified Vulnerabilities

### 1. Memory Exhaustion (DoS)
**Risk**: HIGH  
**Attack Vector**: Attacker uploads large JSON file (1GB+) to IPFS and points token metadata URI to it.

**Current Code**:
```typescript
let data = '';
res.on('data', (chunk) => {
  data += chunk;  // No size limit check
});
```

**Impact**: 
- Server memory exhaustion
- Potential crashes
- Service unavailability

### 2. Prototype Pollution
**Risk**: MEDIUM  
**Attack Vector**: Malicious JSON with `__proto__`, `constructor`, or `prototype` keys.

**Example Attack Payload**:
```json
{
  "__proto__": {"isAdmin": true},
  "twitter": "https://evil.com"
}
```

**Impact**: 
- Object prototype contamination
- Potential security bypass if data is merged unsafely
- Unpredictable behavior

### 3. SSRF (Server-Side Request Forgery)
**Risk**: HIGH  
**Attack Vector**: IP address URIs or private network endpoints.

**Observed Examples**:
- `http://95.179.167.134:3000/metadata/YWKUMA`
- Potential access to internal services if not properly isolated

**Impact**:
- Internal network reconnaissance
- Access to internal-only services
- Data exfiltration

### 4. Stack Overflow / Deep Nesting
**Risk**: MEDIUM  
**Attack Vector**: Extremely nested JSON structures.

**Example**:
```json
{"a": {"a": {"a": ... // 10,000 levels deep
```

**Impact**:
- Stack overflow crashes
- High CPU usage during parsing
- Service degradation

### 5. No Content-Type Validation
**Risk**: LOW  
**Attack Vector**: Non-JSON responses served as JSON.

**Impact**:
- Parsing errors (handled, but inefficient)
- Potential confusion if HTML/JS is returned

---

## Mitigation Strategy

### Phase 1: Critical Protections (IMMEDIATE)

1. **Size Limits**
   - Maximum response size: 5MB
   - Check during streaming (destroy connection if exceeded)
   - Reject immediately, no retries

2. **URI Validation**
   - Reject IP addresses (require hostnames)
   - Reject private network addresses (192.168.x.x, 10.x.x.x, etc.)
   - Reject localhost variants
   - Prefer HTTPS over HTTP (warning for HTTP)
   - Whitelist common gateways (ipfs.io, arweave.net, etc.) or reject suspicious hosts

3. **Prototype Pollution Protection**
   - Strip `__proto__`, `constructor`, `prototype` keys during parsing
   - Use safe object creation (`Object.create(null)`)
   - Sanitize all parsed data before use

### Phase 2: Enhanced Security (SHORT TERM)

4. **JSON Depth Limits**
   - Maximum nesting depth: 20 levels
   - Reject deeper structures
   - Prevent stack overflow

5. **Array/Value Limits**
   - Maximum array size: 1,000 elements
   - Maximum string length: 10,000 characters
   - Truncate or reject larger values

6. **Content-Type Verification**
   - Verify `Content-Type: application/json` header
   - Log warnings for unexpected types
   - Consider rejecting non-JSON types

7. **Safe Logging**
   - Sanitize URIs in logs (remove query params, credentials)
   - Truncate long URIs
   - Don't log sensitive data

### Implementation Details

**File**: `src/core/services/onchain-metadata.service.ts`

**Key Methods to Update**:
- `fetchMetadataFromUri()` - Add size limits, Content-Type checks
- `fetchMetadataFromUriWithRetry()` - Add URI validation before retries
- New: `validateUri()` - URI security validation
- New: `sanitizeMetadata()` - Prototype pollution protection, depth limits
- New: `safeJsonParse()` - Wrapper with size/depth checks
- New: `sanitizeUriForLogging()` - Safe logging

**Configuration Constants**:
```typescript
const MAX_METADATA_SIZE = 5 * 1024 * 1024; // 5MB
const MAX_JSON_DEPTH = 20;
const ALLOWED_URI_SCHEMES = ['https:', 'http:'];
const SUSPICIOUS_HOSTS = ['localhost', '127.0.0.1', '192.168', '10.', '172.16'];
```

**Error Handling**:
- Security rejections should NOT trigger retries
- Log security warnings separately from network errors
- Return clear error messages (without exposing internal details)

---

## Implementation Priority

**URGENT**: This vulnerability is actively being exploited (suspicious URIs observed in logs). Implement Phase 1 immediately.

**Recommended Order**:
1. ✅ Size limits (prevents DoS)
2. ✅ URI validation (prevents SSRF)
3. ✅ Prototype pollution protection (prevents object contamination)
4. ✅ Depth limits (prevents stack overflow)
5. ⏳ Content-Type verification (nice to have)
6. ⏳ Enhanced logging (operational improvement)

---

## Testing

After implementation, test with:

1. **Large file**: Point to >5MB JSON file → Should reject
2. **IP address URI**: `http://192.168.1.1/metadata.json` → Should reject
3. **Prototype pollution**: JSON with `__proto__` → Should strip key
4. **Deep nesting**: 50-level nested object → Should reject
5. **Valid IPFS**: `https://ipfs.io/ipfs/Qm...` → Should work
6. **Valid Arweave**: `https://arweave.net/...` → Should work

---

## References

- **Patch Code**: See conversation history for full implementation
- **Affected Service**: `src/core/services/onchain-metadata.service.ts`
- **Related**: `src/scripts/fetch-token-metadata.ts` (also needs similar protection)

---

## Notes

- The user removed the security patch initially, likely for testing/compatibility
- Re-implementation needed with proper review
- Consider feature flag for gradual rollout
- Monitor logs for continued suspicious activity after deployment

