# Metrics and Analysis Services Assessment

This document outlines the assessment of various analysis services within the project. The goal is to improve the quality, logical grouping, and informativeness of metrics, ensuring consistency and identifying areas for enhancement.

## Phase 1: PNL and Advanced Statistics Analysis

This section covers services primarily responsible for calculating Profit and Loss (PNL) and related statistical measures.

### Services Analyzed:

1.  **`PnlAnalysisService` (`src/core/services/pnl-analysis-service.ts`)**: Orchestrates PNL and advanced stats calculations.
2.  **`SwapAnalyzer` (`src/core/analysis/swap/analyzer.ts`)**: Calculates per-token PNL and handles stablecoin flows.
3.  **`AdvancedStatsAnalyzer` (`src/core/analysis/stats/analyzer.ts`)**: Calculates portfolio-level advanced trading statistics.

### A. `PnlAnalysisService` Assessment

*   **Role**: Orchestrator.
*   **Inputs**: `SwapAnalysisInput[]` (raw swap data from DB for a wallet).
*   **Key Operations**:
    *   Invokes `SwapAnalyzer.analyze()` for per-token PNL.
    *   Aggregates overall PNL metrics from `SwapAnalyzer` results (see table below).
    *   Invokes `AdvancedStatsAnalyzer.analyze()` with non-stablecoin results from `SwapAnalyzer`.
    *   Persists `AnalysisResult` (per-token PNL) and `AdvancedStatsResult` (portfolio stats) to the database.
    *   Updates `Wallet.lastSignatureAnalyzed`.
*   **Primary Output Type**: `SwapAnalysisSummary` (details below).

### B. `SwapAnalyzer` Assessment

*   **Role**: Core PNL calculation per token.
*   **Inputs**: `SwapAnalysisInput[]`, `walletAddress`.
*   **Key Outputs (Per-Token in `OnChainAnalysisResult[]`)**:
    *   `tokenAddress`, `totalAmountIn`, `totalAmountOut`, `netAmountChange`
    *   `totalSolSpent`, `totalSolReceived`, `totalFeesPaidInSol`
    *   `netSolProfitLoss`
    *   `estimatedPreservedValue` (for stablecoins)
    *   `isValuePreservation`, `preservationType`
    *   `transferCountIn`, `transferCountOut`
    *   `firstTransferTimestamp`, `lastTransferTimestamp`
*   **Key Aggregated Outputs (returned alongside per-token results)**:
    *   `processedSignaturesCount`
    *   `firstTimestamp` (overall from input)
    *   `lastTimestamp` (overall from input)
    *   `stablecoinNetFlow` (Net SOL flow to/from stablecoins)
*   **Notes**: Filters out WSOL and 'BURN' interaction types.

### C. `AdvancedStatsAnalyzer` Assessment

*   **Role**: Calculates portfolio-level statistical measures from PNL data.
*   **Inputs**: `OnChainAnalysisResult[]` (typically non-stablecoin results).
*   **Key Outputs (`AdvancedTradeStats` object)**:
    *   `medianPnlPerToken` (on non-zero PNLs)
    *   `trimmedMeanPnlPerToken`
    *   `tokenWinRatePercent`
    *   `standardDeviationPnl`
    *   `medianPnlToVolatilityRatio` (Replaced `profitConsistencyIndex`)
    *   `weightedEfficiencyScore` (Formula revised for linear win rate impact)
    *   `averagePnlPerDayActiveApprox`
    *   `firstTransactionTimestamp` (from its input)
    *   `lastTransactionTimestamp` (from its input)

### Initial Thoughts & Potential Improvements (PNL & Advanced Stats):

1.  **Logical Grouping**: The current separation of concerns between `PnlAnalysisService` (orchestration & DB persistence), `SwapAnalyzer` (core per-token PNL), and `AdvancedStatsAnalyzer` (portfolio PNL statistics) is generally good.
2.  **Metric Clarity & Naming**: 
    *   `profitableSwaps` / `unprofitableSwaps` in `SwapAnalysisSummary`: These currently count *tokens*. Recommend renaming to `profitableTokens` / `unprofitableTokens` (Marked as implemented in table).
    *   `averagePnlPerDayActiveApprox` in `AdvancedTradeStats`: Consider a shorter alias for reporting if needed (e.g., "Avg PNL / Active Day").
    *   "Net Change" column in P/L reports is now "Net Token Change (Units)" for clarity in reports.
3.  **Potential New Metrics / Enhancements for PNL Context**: (Marked as implemented in table)
    *   `totalSwapsTraded` (renamed `totalExecutedSwapsCount`).
    *   `averagePnlPerTrade` (renamed `averageRealizedPnlPerExecutedSwap`).
4.  **Timestamp Clarity**:
    *   `PnlAnalysisService` (via `SwapAnalysisSummary`) provides `overallFirstTimestamp` / `overallLastTimestamp` based on *all* swap inputs.
    *   `AdvancedStatsAnalyzer` calculates its own `firstTransactionTimestamp` / `lastTransactionTimestamp` based on its *input data* (usually non-stablecoin trades).
    *   This distinction is important and should be clear if timestamps from both sources are used in the same report. The `SwapAnalysisSummary` uses the broader timestamps.

### Metric Mapping Table (PNL & Advanced Stats Focus)

| Metric                          | Source Analyzer/Service      | Output Structure/Type      | Notes                                                                 |
|---------------------------------|------------------------------|----------------------------|-----------------------------------------------------------------------|
| **Per-Token Metrics**           |                              |                            | (from `SwapAnalyzer`, part of `SwapAnalysisSummary.results`)          |
| `tokenAddress`                  | `SwapAnalyzer`               | `OnChainAnalysisResult`    |                                                                       |
| `totalAmountIn`                 | `SwapAnalyzer`               | `OnChain`    |                                                                       |
| `totalAmountOut`                | `SwapAnalyzer`               | `OnChainAnalysisResult`    |                                                                       |
| `netAmountChange`               | `SwapAnalyzer`               | `OnChain`    | Token unit change. Reported as "Net Token Change (Units)".             |
| `totalSolSpent`                 | `SwapAnalyzer`               | `OnChainAnalysisResult`    | Gross SOL spent for the token                                         |
| `totalSolReceived`              | `SwapAnalyzer`               | `OnChainAnalysisResult`    | Gross SOL received for the token                                      |
| `totalFeesPaidInSol`            | `SwapAnalyzer`               | `OnChainAnalysisResult`    | Fees for this token's trades                                          |
| `netSolProfitLoss`              | `SwapAnalyzer`               | `OnChainAnalysisResult`    | (SOL received - SOL spent - Fees)                                     |
| `adjustedNetSolProfitLoss`      | `SwapAnalyzer`               | `OnChainAnalysisResult`    | **REMOVED**                                                           |
| `estimatedPreservedValue`       | `SwapAnalyzer`               | `OnChainAnalysisResult`    | For stablecoins, current SOL value of net holdings                    |
| `isValuePreservation`           | `SwapAnalyzer`               | `OnChainAnalysisResult`    | True for stablecoins                                                  |
| `preservationType`              | `SwapAnalyzer`               | `OnChainAnalysisResult`    | 'stablecoin' or undefined                                             |
| `transferCountIn`               | `SwapAnalyzer`               | `OnChainAnalysisResult`    | Number of buy transactions for the token                              |
| `transferCountOut`              | `SwapAnalyzer`               | `OnChainAnalysisResult`    | Number of sell transactions for the token                             |
| `firstTransferTimestamp`        | `SwapAnalyzer`               | `OnChainAnalysisResult`    | Timestamp of first trade for this token                               |
| `lastTransferTimestamp`         | `SwapAnalyzer`               | `OnChainAnalysisResult`    | Timestamp of last trade for this token                                |
| `currentUiBalance`              | `PnlAnalysisService`         | `OnChainAnalysisResult`    | Implemented. Current UI-friendly balance of the token, from `WalletBalanceService`.                                                        |
| `currentUiBalanceString`        | `PnlAnalysisService`         | `OnChainAnalysisResult`    | Implemented. String representation of current UI balance, from `WalletBalanceService`.                                                   |
| `balanceDecimals`               | `PnlAnalysisService`         | `OnChainAnalysisResult`    | Implemented. Decimals for the token, from `WalletBalanceService`.                                                                        |
| `balanceFetchedAt`              | `PnlAnalysisService`         | `OnChainAnalysisResult`    | Implemented. Timestamp when the current balance for this specific token was fetched, from `WalletBalanceService`.                      |
| **Aggregated PNL Metrics**      |                              |                            | (Primarily in `SwapAnalysisSummary` by `PnlAnalysisService`)          |
| `processedSignaturesCount`      | `SwapAnalyzer`               | `SwapAnalysisSummary`      | Distinct signatures processed by `SwapAnalyzer`                       |
| `stablecoinNetFlow`             | `SwapAnalyzer`               | `SwapAnalysisSummary`      | Net SOL flow to/from all stablecoins                                  |
| `totalVolume`                   | `PnlAnalysisService`         | `SwapAnalysisSummary`      | Sum of (totalSolSpent + totalSolReceived) across all tokens         |
| `totalFees`                     | `PnlAnalysisService`         | `SwapAnalysisSummary`      | Sum of `totalFeesPaidInSol` across all tokens                       |
| `realizedPnl`                   | `PnlAnalysisService`         | `SwapAnalysisSummary`      | Sum of `netSolProfitLoss` for non-stablecoins                         |
| `unrealizedPnl`                 | `PnlAnalysisService`         | `SwapAnalysisSummary`      | Sum of `estimatedPreservedValue` for stablecoins                      |
| `netPnl`                        | `PnlAnalysisService`         | `SwapAnalysisSummary`      | `realizedPnl + unrealizedPnl`                                         |
| `profitableTokensCount`         | `PnlAnalysisService`         | `SwapAnalysisSummary`      | **RENAMED & Implemented** (from `profitableSwaps`)                        |
| `unprofitableTokensCount`       | `PnlAnalysisService`         | `SwapAnalysisSummary`      | **RENAMED & Implemented** (from `unprofitableSwaps`)                        |
| `averageSwapSize`               | `PnlAnalysisService`         | `SwapAnalysisSummary`      | `totalVolume / (profitableTokensCount + unprofitableTokensCount)`       |
| `overallFirstTimestamp`         | `PnlAnalysisService`         | `SwapAnalysisSummary`      | Earliest timestamp from all input swap records                        |
| `overallLastTimestamp`          | `PnlAnalysisService`         | `SwapAnalysisSummary`      | Latest timestamp from all input swap records                          |
| `totalExecutedSwapsCount`       | `PnlAnalysisService`         | `SwapAnalysisSummary`      | **Implemented** (New)                                                 |
| `averageRealizedPnlPerExecutedSwap`| `PnlAnalysisService`    | `SwapAnalysisSummary`      | **Implemented** (New)                                                 |
| `realizedPnlToTotalVolumeRatio` | `PnlAnalysisService`         | `SwapAnalysisSummary`      | **Implemented** (New; PNL efficiency)                                 |
| `currentSolBalance`             | `PnlAnalysisService`         | `SwapAnalysisSummary`      | Implemented. Current SOL balance from `WalletBalanceService`.                                                                              |
| `balancesFetchedAt`             | `PnlAnalysisService`         | `SwapAnalysisSummary`      | Implemented. Timestamp when current SOL and token balances were fetched by `WalletBalanceService`.                                         |
| `tokenBalances`                 | `PnlAnalysisService`         | `SwapAnalysisSummary`      | Implemented. Array of `TokenBalanceDetails` (mint, uiBalance, uiBalanceString, etc.) for current holdings, from `WalletBalanceService`.      |
| **Advanced Stats Metrics**      |                              |                            | (From `AdvancedStatsAnalyzer`, in `SwapAnalysisSummary.advancedStats`)| 
| `medianPnlPerToken`             | `AdvancedStatsAnalyzer`      | `AdvancedTradeStats`       | Median PNL of non-zero PNL tokens                                     |
| `trimmedMeanPnlPerToken`        | `AdvancedStatsAnalyzer`      | `AdvancedTradeStats`       | Mean PNL after trimming extremes                                      |
| `tokenWinRatePercent`           | `AdvancedStatsAnalyzer`      | `AdvancedTradeStats`       | % of non-zero PNL tokens with PNL > WIN_THRESHOLD_SOL. Denominator unified. |
| `standardDeviationPnl`          | `AdvancedStatsAnalyzer`      | `AdvancedTradeStats`       | Sample standard deviation of PNLs                                     |
| `medianPnlToVolatilityRatio`    | `AdvancedStatsAnalyzer`      | `AdvancedTradeStats`       | **New:** `medianPnlPerToken / standardDeviationPnl` (Replaced `profitConsistencyIndex`) | 
| `weightedEfficiencyScore`       | `AdvancedStatsAnalyzer`      | `AdvancedTradeStats`       | Custom index based on avg PNL and win rate (Formula revised)          |
| `averagePnlPerDayActiveApprox`  | `AdvancedStatsAnalyzer`      | `AdvancedTradeStats`       | Proxy for PNL per day token was actively traded                       |
| `firstTransactionTimestamp (adv)`| `AdvancedStatsAnalyzer`      | `AdvancedTradeStats`       | Earliest timestamp from trades input to AdvancedStatsAnalyzer         |
| `lastTransactionTimestamp (adv)`| `AdvancedStatsAnalyzer`      | `AdvancedTradeStats`       | Latest timestamp from trades input to AdvancedStatsAnalyzer           |

## Phase 2: Behavior Analysis

This section covers services primarily responsible for analyzing wallet trading patterns and classifying behavior.

### Services Analyzed:

1.  **`BehaviorService` (`src/core/analysis/behavior/behavior-service.ts`)**: Orchestrates behavior analysis.
2.  **`BehaviorAnalyzer` (`src/core/analysis/behavior/analyzer.ts`)**: Calculates detailed behavioral metrics and classifies trading styles.
3.  **`KPIComparisonAnalyzer` (`src/core/analysis/behavior/kpi_analyzer.ts`)**: Formats and compares behavioral metrics for multiple wallets.

### D. `BehaviorService` Assessment

*   **Role**: Orchestrator.
*   **Inputs**: `walletAddress`, `BehaviorAnalysisConfig`, `DatabaseService`.
*   **Key Operations**:
    *   Fetches `SwapAnalysisInput[]` from `DatabaseService`.
    *   Instantiates and uses `BehaviorAnalyzer` to get `BehavioralMetrics`.
*   **Primary Output Type**: `BehavioralMetrics | null`.

### E. `BehaviorAnalyzer` Assessment

*   **Role**: Core calculation of behavioral metrics and trading style classification.
*   **Inputs**: `SwapAnalysisInput[]`, `BehaviorAnalysisConfig`.
*   **Primary Output Type**: `BehavioralMetrics` object, which includes:
    *   **Flipper Metrics**: `buySellRatio`, `buySellSymmetry`, `averageFlipDurationHours`, `medianHoldTime`, `sequenceConsistency`, `flipperScore` (overall ratio penalty removed from calculation).
    *   **Activity Metrics**: `uniqueTokensTraded`, `tokensWithBothBuyAndSell`, `totalTradeCount`, `totalBuyCount`, `totalSellCount`, `completePairsCount`, `averageTradesPerToken`.
    *   **Time Distribution**: `tradingTimeDistribution` (object with % in time buckets like <30m, 1-4h, etc.), `percentTradesUnder1Hour`, `percentTradesUnder4Hours`.
    *   **Classification**: `tradingStyle`, `confidenceScore`.
    *   **Timestamps**: `firstTransactionTimestamp`, `lastTransactionTimestamp` (from input swaps).
    *   **Refined Metrics (Previously Placeholders)**:
        *   `tradingFrequency`: Implemented (daily, weekly, monthly based on consistent rate logic).
        *   `tokenPreferences`: `mostTradedTokens` implemented.
        *   `riskMetrics`: `averageTransactionValueSol`, `largestTransactionValueSol` implemented.

### F. `KPIComparisonAnalyzer` Assessment

*   **Role**: Generates a formatted string report comparing `BehavioralMetrics` across multiple wallets.
*   **Inputs**: `Array<{ wallet: WalletInfo, metrics: BehavioralMetrics }>$.
*   **Key Operations**: Formats existing `BehavioralMetrics` into tables. Does not calculate new primary metrics.
*   **Primary Output Type**: `string` (formatted report).

### Initial Thoughts & Potential Improvements (Behavior Analysis):

1.  **Logical Grouping**: Generally good.
2.  **Placeholder Metrics in `BehavioralMetrics` - Recommendations**: (Most addressed in table)
    *   `profitMetrics` (totalPnL, winRate, etc.): Removed.
    *   `riskMetrics`: Implemented `averageTransactionValueSol`, `largestTransactionValueSol`. `diversificationScore` removed.
    *   `tokenPreferences`: Implemented `mostTradedTokens`. `mostProfitableTokens` removed. `mostHeldTokens` (now `topNetPositiveAmountTokens`) postponed.
    *   `tradingFrequency`: Implemented with consistent rate logic.
3.  **Clarity**: Core behavioral metrics (flipper score, symmetry, consistency, time distributions) are well-defined. Flipper score calculation was refined (penalty removed).
4.  **Overlap**: PNL-related placeholders removed, improving modularity.

### Metric Mapping Table (Behavior Analysis Focus)

| Metric                          | Source Analyzer/Service      | Output Structure/Type      | Notes                                                                    |
|---------------------------------|------------------------------|----------------------------|--------------------------------------------------------------------------|
| **Flipper Metrics**             |                              |                            | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                        |
| `buySellRatio`                  | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Overall ratio of total buys to total sells. Per-token ratio inversion removed. |
| `buySellSymmetry`               | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Avg. buy/sell count symmetry per token (for tokens with both).         |
| `averageFlipDurationHours`      | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Avg. time between buy and subsequent sell.                               |
| `medianHoldTime`                | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Median time for buy-sell flips.                                          |
| `sequenceConsistency`           | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Avg. ratio of actual completed pairs to max possible pairs per token.    |
| `flipperScore`                  | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Score (0-1) indicating flipper-like behavior. (Overall ratio penalty removed). |
| **Activity Metrics**            |                              |                            | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                        |
| `uniqueTokensTraded`            | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Count of unique tokens in any trade.                                     |
| `tokensWithBothBuyAndSell`      | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Count of tokens with at least one buy AND one sell.                      |
| `totalTradeCount`               | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Total buy and sell transactions.                                         |
| `totalBuyCount`                 | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Total buy transactions.                                                  |
| `totalSellCount`                | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Total sell transactions.                                                 |
| `completePairsCount`            | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Total buy-then-sell round trips across all tokens.                       |
| `averageTradesPerToken`         | `BehaviorAnalyzer`           | `BehavioralMetrics`        | `totalTradeCount / uniqueTokensTraded`. (Zero division guarded)          |
| **Time Distribution**           |                              |                            | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                        |
| `tradingTimeDistribution`       | `BehaviorAnalyzer`           | `BehavioralMetrics`        | % of flips in time buckets (ultraFast, veryFast, fast, etc.).            |
| `percentTradesUnder1Hour`       | `BehaviorAnalyzer`           | `BehavioralMetrics`        | % flips < 1 hour.                                                        |
| `percentTradesUnder4Hours`      | `BehaviorAnalyzer`           | `BehavioralMetrics`        | % flips < 4 hours.                                                       |
| **Classification**              |                              |                            | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                        |
| `tradingStyle`                  | `BehaviorAnalyzer`           | `BehavioralMetrics`        | e.g., "True Flipper", "Accumulator".                                     |
| `confidenceScore`               | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Confidence in `tradingStyle`.                                            |
| **Timestamps**                  |                              |                            | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                        |
| `firstTransactionTimestamp`     | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Earliest timestamp from input swaps.                                     |
| `lastTransactionTimestamp`      | `BehaviorAnalyzer`           | `BehavioralMetrics`        | Latest timestamp from input swaps.                                       |
| **Refined/New Behavioral Metrics** |                         |                       |                                                                                       |
| `tradingFrequency.tradesPerDay`    | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (Consistent rate logic)                                         |
| `tradingFrequency.tradesPerWeek`   | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (Consistent rate logic)                                         |
| `tradingFrequency.tradesPerMonth`  | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (Consistent rate logic)                                         |
| `tokenPreferences.mostTradedTokens`| `BehaviorAnalyzer`      | `BehavioralMetrics`   | **RENAMED & Implemented** (Calculation defined, was `mostTraded`)                  |
| `riskMetrics.averageTransactionValueSol`| `BehaviorAnalyzer` | `BehavioralMetrics`   | **RENAMED & Implemented** (Calculation defined, was `averageTransactionSize`)        |
| `riskMetrics.largestTransactionValueSol`| `BehaviorAnalyzer`  | `BehavioralMetrics`   | **RENAMED & Implemented** (Calculation defined, was `largestTransaction`)            |
| `reentryRate`                      | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New; token re-trade tendency)                              |
| `percentageOfUnpairedTokens`       | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New; ratio of incomplete buy/sell token cycles)              |
| `sessionCount`                     | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New; count of trade sessions)                                |
| `avgTradesPerSession`              | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New; trades per session)                                   |
| `activeTradingPeriods`             | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented (Refined)** (Replaced `activeHoursDistribution`. New type `ActiveTradingPeriods` with hourly counts, dynamic windows, focus score, circular mean for avg session start, and window merging.) | 
| `averageSessionStartHour`          | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New; avg session start hour, uses circular mean)           |
| `averageSessionDurationMinutes`    | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New; avg session length in minutes)                        |
| **Removed/Postponed Metrics**      |                         |                       |                                                                                       |
| `profitMetrics.*`                  | `N/A (was Behavior)`    | `BehavioralMetrics`   | **REMOVED** (All fields from `BehavioralMetrics`)                             |
| `riskMetrics.diversificationScore` | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **REMOVED**                                                                   |
| `tokenPreferences.mostProfitableTokens`| `N/A (was Behavior)`| `BehavioralMetrics`   | **REMOVED**                                                                   |
| `tokenPreferences.topNetPositiveAmountTokens`| `BehaviorAnalyzer`| `BehavioralMetrics`   | **POSTPONED/Re-evaluate** (Was `mostHeld`; note concerns about interpretation)        |
| **Future Considerations (Volatility)**|                       |                       |                                                                                       |
| `flipDurationStandardDeviation`    | `BehaviorAnalyzer`      | `BehavioralMetrics`   | *Future Consideration*: Measure consistency in flip times.                            |
| `tradeValueStandardDeviationSol`   | `BehaviorAnalyzer`      | `BehavioralMetrics`   | *Future Consideration*: Measure consistency in trade sizing (SOL value).              |
| `sessionActivityVariance`           | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Future Consideration**: A measure of the variance or entropy in session start times or durations.
| `dayOfWeekActivityBias`            | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Future Consideration**: A breakdown or score indicating if trading activity is biased towards weekdays vs. weekends, or specific days.

## Phase 3: Action Plan for Metric Refinement (PNL, Advanced Stats, Behavior)

This section outlines specific actions to consolidate, clarify, and enhance the metrics from PNL, Advanced Stats, and Behavior analysis modules, aiming for a more cohesive and informative output suitable for dashboarding. The "Status" column in the tables below reflects the outcome of this action plan.

### 3.1. PNL & Advanced Statistics (`PnlAnalysisService`, `SwapAnalyzer`, `AdvancedStatsAnalyzer`)

**Objective**: Ensure PNL metrics are comprehensive, clearly named, and provide sufficient context for wallet performance assessment.

**Actions & Refinements:**

1.  **Metric Naming Clarity (in `SwapAnalysisSummary` and dependent types):**
    *   **Target Metrics**: `profitableSwaps`, `unprofitableSwaps`.
    *   **Action**: Rename to `profitableTokensCount` and `unprofitableTokensCount` respectively.
    *   **Rationale**: These metrics count tokens with net positive/negative PNL, not individual swap transactions.
    *   **Impacted Files**: `PnlAnalysisService` (aggregation logic where these are summed up), type definition for `SwapAnalysisSummary` (e.g., in `helius-api.ts`), any reporting utilities consuming these.

2.  **Contextual PNL Metrics (New Additions to `SwapAnalysisSummary`):**
    *   **Metric**: `totalExecutedSwapsCount` (New)
        *   **Definition**: Total number of buy and sell operations for non-stablecoin tokens.
        *   **Calculation**: In `PnlAnalysisService`, sum `transferCountIn` and `transferCountOut` from all `OnChainAnalysisResult` items where `isValuePreservation` is `false`.
        *   **Rationale**: Provides a clear count of trading activities directly contributing to realized PNL.
    *   **Metric**: `averageRealizedPnlPerExecutedSwap` (New)
        *   **Definition**: Average PNL achieved per executed non-stablecoin swap.
        *   **Calculation**: In `PnlAnalysisService`, calculate as `realizedPnl / totalExecutedSwapsCount` (ensure `totalExecutedSwapsCount > 0`).
        *   **Rationale**: Offers a trade-level performance view, complementing token-level PNL.
    *   **Impacted Files**: `PnlAnalysisService` (implement new calculations), type definition for `SwapAnalysisSummary`.

3.  **Review `OnChainAnalysisResult.adjustedNetSolProfitLoss`:**
    *   **Action**: **Remove** `adjustedNetSolProfitLoss` from `OnChainAnalysisResult` (and consequently from `SwapAnalyzer`'s output and DB storage).
    *   **Rationale**: Per critique, minimises complexity unless a specific, near-term adjustment logic (IL, complex slippage) is planned. `netSolProfitLoss` will be the sole PNL figure per token.
    *   **Impacted Files**: `SwapAnalyzer`, `OnChainAnalysisResult` type definition, Prisma schema for `AnalysisResult`.

4.  **Timestamp Consistency & Reporting:**
    *   **Clarification**: Reports combining PNL data with other analyses must clearly distinguish timestamp contexts.
    *   `SwapAnalysisSummary.overallFirstTimestamp` and `overallLastTimestamp` (from `PnlAnalysisService` based on *all* `SwapAnalysisInput`) represent the broadest period.
    *   `AdvancedTradeStats.firstTransactionTimestamp` and `lastTransactionTimestamp` (from `AdvancedStatsAnalyzer`) cover only the subset of trades (usually non-stablecoin) used for its specific statistical calculations.
    *   `BehavioralMetrics.firstTransactionTimestamp` and `lastTransactionTimestamp` (from `BehaviorAnalyzer`) cover all trades input to it.
    *   **Recommendation**: For dashboard views, prioritize the broadest relevant time window or allow user selection with clear labeling of what data subset a given timestamp range applies to. Strongly recommend defining clear data ownership for timestamps or using a shared `TimeWindow` object if multiple layers report them to prevent desync drift.

5.  **New PNL Efficiency Metric (to `SwapAnalysisSummary`):**
    *   **Metric**: `realizedPnlToTotalVolumeRatio: number`
    *   **Definition**: `realizedPnl / totalVolume` (ensure `totalVolume !== 0`).
    *   **Rationale**: Measures PNL efficiency per unit of total SOL volume transacted. A higher ratio indicates more PNL generated per SOL moved. Complements existing gross PnL stats.
    *   **Derivation**: Uses `realizedPnl` and `totalVolume`, which are already calculated in `PnlAnalysisService` for `SwapAnalysisSummary`.
    *   **Impacted Files**: `PnlAnalysisService` (add calculation), `SwapAnalysisSummary` type definition.

### 3.2. Behavior Analysis (`BehaviorService`, `BehaviorAnalyzer`)

**Objective**: Streamline behavioral metrics to focus on unique behavioral patterns, remove PNL overlap, and implement meaningful placeholder metrics.

**Note on `BehaviorAnalyzer` Scope:** While `BehaviorAnalyzer` is currently planned to house all detailed behavioral calculations for efficiency (leveraging a single pass over trade data where possible), its scope has grown with the inclusion of diverse metric categories (core patterns, token interactions, session analysis). If future additions significantly increase its complexity or if specific parts (like session analysis) prove broadly reusable, consider refactoring it into more specialized sub-analyzers (e.g., `FlipPatternAnalyzer`, `SessionAnalyzer`, `TokenInteractionAnalyzer`) to maintain clarity, testability, and adherence to the Single Responsibility Principle.

**Actions & Refinements (primarily within `BehaviorAnalyzer` and the `BehavioralMetrics` type):**

1.  **Remove PNL Overlap:**
    *   **Target Metrics**: Entire `profitMetrics` field (`{ totalPnL, winRate, averageProfitPerTrade, profitConsistency }`).
    *   **Action**: **Remove** from `BehavioralMetrics` type and `getEmptyMetrics()` in `BehaviorAnalyzer`.
    *   **Rationale**: PNL data must be sourced from `PnlAnalysisService`. Keeps `BehaviorAnalyzer` focused on non-PNL behavioral patterns.
    *   **Impacted Files**: `BehaviorAnalyzer`, `BehavioralMetrics` type definition (e.g., in `behavior.ts`).

2.  **Implement and Refine `riskMetrics` (in `BehavioralMetrics`):**
    *   **Metric**: `averageTransactionValueSol` (Replaces `averageTransactionSize`)
        *   **Definition**: Average SOL value of all buy and sell transactions.
        *   **Calculation**: In `BehaviorAnalyzer`, sum `transaction.associatedSolValue` for all `SwapAnalysisInput` records, then divide by `totalTradeCount` (if `totalTradeCount > 0`).
    *   **Metric**: `largestTransactionValueSol` (Replaces `largestTransaction`)
        *   **Definition**: The largest SOL value observed in a single transaction.
        *   **Calculation**: In `BehaviorAnalyzer`, find `Math.max(transaction.associatedSolValue)` from all `SwapAnalysisInput` records.
    *   **Metric**: `diversificationScore`
        *   **Action**: **Remove.**
        *   **Rationale**: Per critique, analytically weak without a robust definition (e.g., capital risk weighting) and risks redundancy or being misleading.
    *   **Impacted Files**: `BehaviorAnalyzer` (update calculations, remove `diversificationScore`), `BehavioralMetrics` type definition.

3.  **Implement and Refine `tokenPreferences` (in `BehavioralMetrics`):**
    *   **Metric**: `mostTradedTokens` (`string[]`, replaces `mostTraded`)
        *   **Definition**: List of top N (e.g., 3-5) token mints by total trade count (buys + sells).
        *   **Calculation**: In `BehaviorAnalyzer` (likely within/after `buildTokenSequences`), aggregate trade counts per mint, sort, and take top N.
    *   **Metric**: `mostProfitableTokens`
        *   **Action**: **Remove.**
        *   **Rationale**: PNL-dependent; should be derived from `PnlAnalysisService` data by the application/dashboard if needed.
    *   **Metric**: `topNetPositiveAmountTokens` (`string[]`, replaces `mostHeld`)
        *   **Action**: **Postpone or Re-evaluate.**
        *   **Rationale**: Per critique, raw net positive amount can be misleading (airdrops, junk). If implemented later, requires careful annotation or refined calculation (e.g., volume-weighting, user-initiated only). For now, focus on clearer metrics.
    *   **Impacted Files**: `BehaviorAnalyzer`, `BehavioralMetrics` type definition.

4.  **Implement `tradingFrequency` (in `BehavioralMetrics`):**
    *   **Metrics**: `tradesPerDay: number`, `tradesPerWeek: number`, `tradesPerMonth: number`.
    *   **Definition**: Average number of trades over different periods.
    *   **Calculation**: In `BehaviorAnalyzer`, using `firstTransactionTimestamp`, `lastTransactionTimestamp`, and `totalTradeCount`:
        *   `durationDays = (lastTransactionTimestamp - firstTransactionTimestamp) / (60 * 60 * 24)`. If `durationDays <= 0`, treat as `1` for daily average to avoid division by zero or negative durations with minimal data. (Note: recent refactor uses `minRateCalculationDurationDays` which is more robust).
        *   `tradesPerDay = totalTradeCount / durationDays` (or `minRateCalculationDurationDays`).
        *   `tradesPerWeek = tradesPerDay * 7`.
        *   `tradesPerMonth = tradesPerDay * 30.44` (avg days per month).
    *   **Impacted Files**: `BehaviorAnalyzer`, `BehavioralMetrics` type definition.

5.  **New Behavioral Metrics (to `BehavioralMetrics` via `BehaviorAnalyzer`):**
    *   **Metric**: `reentryRate: number`
        *   **Definition**: `tokensWithMultipleCycles / tokensWithBothBuyAndSell` (if `tokensWithBothBuyAndSell > 0`).
        *   **Rationale**: Reveals tendency to re-trade the same token, indicating confidence, obsession, or bot looping.
        *   **Derivation**: `tokensWithBothBuyAndSell` is existing. `tokensWithMultipleCycles` is a new count of tokens that have more than one completed buy-sell pair (e.g., `tokenSequence.completedPairTimestamps.length > 1`). Calculated in `BehaviorAnalyzer`.
    *   **Metric**: `percentageOfUnpairedTokens: number`
        *   **Definition**: `((uniqueTokensTraded - tokensWithBothBuyAndSell) / uniqueTokensTraded) * 100` (if `uniqueTokensTraded > 0`).
        *   **Rationale**: Shows ratio of incomplete cycles (buy-only or sell-only). Critical to detect accumulation, rage exits, or farming.
        *   **Derivation**: Uses existing `uniqueTokensTraded` and `tokensWithBothBuyAndSell` from `BehavioralMetrics`.
    *   **Impacted Files (for both above)**: `BehaviorAnalyzer`, `BehavioralMetrics` type definition.

6.  **New Session-Based Behavioral Metrics (to `BehavioralMetrics` via `BehaviorAnalyzer`):**
    *   **Session Definition**: A session is a sequence of trades where the time gap between consecutive trades is less than or equal to a defined threshold (e.g., 60 minutes).
    *   **Metric**: `sessionCount: number`
        *   **Definition**: Number of distinct trading sessions.
        *   **Rationale**: Exposes episodic vs. continuous trading.
    *   **Metric**: `avgTradesPerSession: number`
        *   **Definition**: `totalTradeCount / sessionCount` (if `sessionCount > 0`).
        *   **Rationale**: Average number of trades within a typical session.
    *   **Metric**: `activeTradingPeriods: ActiveTradingPeriods` (Replaces previous `activeHoursDistribution: Record<number, number>`)
        *   **Definition**: Provides a structured analysis of trading activity across UTC hours, including raw hourly counts, dynamically identified significant trading windows, and a focus score.
        *   **Type Definition (`ActiveTradingPeriods`)**:
            *   `hourlyTradeCounts: Record<number, number>`: Raw trade counts for each UTC hour (0-23).
            *   `identifiedWindows: IdentifiedTradingWindow[]`: Array of dynamically identified significant trading windows. Each `IdentifiedTradingWindow` includes:
                *   `startTimeUTC: number` (0-23)
                *   `endTimeUTC: number` (0-23, inclusive)
                *   `durationHours: number`
                *   `tradeCountInWindow: number`
                *   `percentageOfTotalTrades: number`
                *   `avgTradesPerHourInWindow: number`
            *   `activityFocusScore: number`: Metric (e.g., 0-1) indicating how concentrated trades are (e.g., higher score = more focused activity within identified windows).
        *   **Rationale**: Moves beyond simple hourly counts to algorithmically highlight dominant trading periods, understand activity concentration, and provide richer, more interpretable insights into a user's trading schedule. Addresses limitations of fixed-time buckets and provides data for flexible dashboard visualizations.
        *   **High-Level Calculation Steps**:
            1.  Calculate raw `hourlyTradeCounts` (UTC) from all swap records.
            2.  (Optional) Apply smoothing (e.g., 3-hour moving average) to `hourlyTradeCounts` to get `smoothedHourlyCounts`.
            3.  Determine an adaptive activity threshold (e.g., 75th-80th percentile of non-zero values in `smoothedHourlyCounts` or values > 1-1.5 std dev above the mean of non-zero hourly counts).
            4.  Identify `identifiedWindows` by grouping consecutive hours where activity in `smoothedHourlyCounts` exceeds the threshold. Calculate properties for each window using original `hourlyTradeCounts`. Insignificant windows (e.g., too short, too few trades) may be filtered.
            5.  Calculate `activityFocusScore` (e.g., percentage of total trades falling within `identifiedWindows`, or normalized Shannon entropy of `hourlyTradeCounts`).
            6.  (Optional) Perform a merge pass on identified windows to combine adjacent windows separated by short, insignificant dips in activity.
    *   **Metric**: `averageSessionStartHour: number`
        *   **Definition**: Average start hour (0-23 UTC) of identified trading sessions, calculated using a circular mean to correctly handle wrap-around (e.g., sessions starting near midnight).
        *   **Rationale**: Reveals typical trading window start.
    *   **Metric**: `averageSessionDurationMinutes: number`
        *   **Definition**: Average length of trading sessions in minutes.
        *   **Rationale**: Reveals typical trading window length.
    *   **Derivation (for all session metrics)**:
        *   Sort all `SwapAnalysisInput` by timestamp.
        *   Iterate through sorted trades to identify sessions based on the time gap threshold.
        *   For `activeTradingPeriods`, iterate all trades and group by hour.
        *   For session-specific metrics, iterate identified sessions.
    *   **Impacted Files (for all session metrics)**: `BehaviorAnalyzer`, `BehavioralMetrics` type definition.

7.  **Future Consideration: Behavioral Volatility/Consistency Metrics (in `BehavioralMetrics`):** (Renumbered from 5)
    *   **Metric Idea**: `flipDurationStandardDeviation`
        *   **Definition**: Standard deviation of flip durations (output of `calculateFlipDurations`).
        *   **Calculation**: In `BehaviorAnalyzer`, after `calculateTimeDistributions` (which already gets `allDurations`), calculate standard deviation on `allDurations`.
        *   **Rationale**: Measures consistency in holding/flipping times. This can be a valuable addition for a richer behavioral profile.
    *   **Metric Idea**: `tradeValueStandardDeviationSol` (Moved from 3.2.2)
        *   **Definition**: Standard deviation of `associatedSolValue` for all trades.
        *   **Calculation**: In `BehaviorAnalyzer`, calculate standard deviation of the list of `associatedSolValue` from all `SwapAnalysisInput`.
        *   **Rationale**: Adds a basic measure of consistency/volatility in trade sizing.
    *   **Metric Idea**: `sessionActivityVariance`
        *   **Definition**: A measure of the variance or entropy in session start times or durations.
        *   **Calculation**: Could involve calculating the standard deviation of session start times (using circular statistics) or the entropy of the distribution of session start hours.
        *   **Rationale**: Quantifies the regularity or randomness of a user's session engagement. High variance might indicate erratic behavior, while low variance suggests consistent timing.
    *   **Metric Idea**: `dayOfWeekActivityBias`
        *   **Definition**: A breakdown or score indicating if trading activity is biased towards weekdays vs. weekends, or specific days.
        *   **Calculation**: Could involve calculating `activeTradingPeriods` (or simpler trade counts) separately for weekdays and weekends, or for each day of the week.
        *   **Rationale**: Provides context on whether trading is part of a "work-week" routine or more of a weekend/off-hours activity.
    *   **Note**: These are flagged as future considerations to enrich the behavioral analysis. PNL volatility per token would be a separate effort, likely for `AdvancedStatsAnalyzer`.

### 3.3. Updated Metric Mapping Tables

The following tables reflect the planned changes from this action plan.

**PNL & Advanced Stats Focus - Updated Table**

| Metric                             | Source Analyzer/Service | Output Structure/Type   | Status & Notes                                                                                                                               |
|------------------------------------|-------------------------|------------------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| **Per-Token Metrics**              |                         |                         | (from `SwapAnalyzer`, part of `SwapAnalysisSummary.results`)                                                                                 |
| `tokenAddress`                     | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. The address of the token.                                                                                                     |
| `totalAmountIn`                    | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Total amount of the token received (bought).                                                                                  |
| `totalAmountOut`                   | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Total amount of the token sent (sold).                                                                                      |
| `netAmountChange`                  | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Token unit change (`totalAmountIn` - `totalAmountOut`). Reported as "Net Token Change (Units)".                                 |
| `totalSolSpent`                    | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Gross SOL spent to acquire the token.                                                                                         |
| `totalSolReceived`                 | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Gross SOL received from selling the token.                                                                                    |
| `totalFeesPaidInSol`               | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Total fees paid in SOL for trades involving this token.                                                                       |
| `netSolProfitLoss`                 | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. (`totalSolReceived` - `totalSolSpent` - `totalFeesPaidInSol`) for this token.                                                 |
| `adjustedNetSolProfitLoss`         | `SwapAnalyzer`          | `OnChainAnalysisResult` | **REMOVED**. Previously an adjusted PNL, removed to simplify.                                                                            |
| `estimatedPreservedValue`          | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented (for stablecoins). Current SOL value of net holdings for stablecoins.                                                          |
| `isValuePreservation`              | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Boolean, true if the token is considered for value preservation (e.g., a stablecoin).                                       |
| `preservationType`                 | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Type of preservation, e.g., 'stablecoin' or undefined.                                                                      |
| `transferCountIn`                  | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Number of buy transactions for the token.                                                                                     |
| `transferCountOut`                 | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Number of sell transactions for the token.                                                                                    |
| `firstTransferTimestamp`           | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Timestamp of the first trade (buy or sell) for this token.                                                                  |
| `lastTransferTimestamp`            | `SwapAnalyzer`          | `OnChainAnalysisResult` | Implemented. Timestamp of the last trade (buy or sell) for this token.                                                                   |
| `currentUiBalance`                 | `PnlAnalysisService`    | `OnChainAnalysisResult` | Implemented. Current UI-friendly balance of the token, from `WalletBalanceService`.                                                        |
| `currentUiBalanceString`           | `PnlAnalysisService`    | `OnChainAnalysisResult` | Implemented. String representation of current UI balance, from `WalletBalanceService`.                                                   |
| `balanceDecimals`                  | `PnlAnalysisService`    | `OnChainAnalysisResult` | Implemented. Decimals for the token, from `WalletBalanceService`.                                                                        |
| `balanceFetchedAt`                 | `PnlAnalysisService`    | `OnChainAnalysisResult` | Implemented. Timestamp when the current balance for this specific token was fetched, from `WalletBalanceService`.                      |
| **Aggregated PNL Metrics**         |                         |                         | (Primarily in `SwapAnalysisSummary` by `PnlAnalysisService`)                                                                               |
| `processedSignaturesCount`         | `SwapAnalyzer`          | `SwapAnalysisSummary`   | Implemented. Distinct transaction signatures processed by `SwapAnalyzer`.                                                                  |
| `stablecoinNetFlow`                | `SwapAnalyzer`          | `SwapAnalysisSummary`   | Implemented. Net SOL flow to/from all stablecoins.                                                                                         |
| `totalVolume`                      | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Sum of (`totalSolSpent` + `totalSolReceived`) across all tokens (non-stable and stable).                                      |
| `totalFees`                        | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Sum of `totalFeesPaidInSol` across all tokens.                                                                                |
| `realizedPnl`                      | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Sum of `netSolProfitLoss` for non-stablecoin tokens.                                                                          |
| `unrealizedPnl`                    | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Sum of `estimatedPreservedValue` for stablecoins. Represents the current value of stablecoin holdings.                        |
| `netPnl`                           | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. `realizedPnl + unrealizedPnl`.                                                                                                |
| `profitableTokensCount`            | `PnlAnalysisService`    | `SwapAnalysisSummary`   | **RENAMED & Implemented** (from `profitableSwaps`). Count of non-stablecoin tokens with `netSolProfitLoss` > 0.                            |
| `unprofitableTokensCount`          | `PnlAnalysisService`    | `SwapAnalysisSummary`   | **RENAMED & Implemented** (from `unprofitableSwaps`). Count of non-stablecoin tokens with `netSolProfitLoss` < 0.                          |
| `averageSwapSize`                  | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Calculated as `totalVolume / (profitableTokensCount + unprofitableTokensCount)`. Average volume per category of token (profitable or unprofitable). |
| `overallFirstTimestamp`            | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Earliest timestamp from all input swap records to `PnlAnalysisService`.                                                       |
| `overallLastTimestamp`             | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Latest timestamp from all input swap records to `PnlAnalysisService`.                                                         |
| `totalExecutedSwapsCount`          | `PnlAnalysisService`    | `SwapAnalysisSummary`   | **Implemented** (New). Total number of buy (`transferCountIn`) and sell (`transferCountOut`) operations for non-stablecoin tokens. Calculated in `PnlAnalysisService`. |
| `averageRealizedPnlPerExecutedSwap`| `PnlAnalysisService`    | `SwapAnalysisSummary`   | **Implemented** (New). `realizedPnl / totalExecutedSwapsCount`. Average PNL per non-stablecoin swap. Calculated in `PnlAnalysisService`.     |
| `realizedPnlToTotalVolumeRatio`    | `PnlAnalysisService`    | `SwapAnalysisSummary`   | **Implemented** (New; PNL efficiency). `realizedPnl / totalVolume`. Measures PNL generated per unit of total SOL volume transacted. Calculated in `PnlAnalysisService`. |
| `currentSolBalance`                | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Current SOL balance from `WalletBalanceService`.                                                                              |
| `balancesFetchedAt`                | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Timestamp when current SOL and token balances were fetched by `WalletBalanceService`.                                         |
| `tokenBalances`                    | `PnlAnalysisService`    | `SwapAnalysisSummary`   | Implemented. Array of `TokenBalanceDetails` (mint, uiBalance, uiBalanceString, etc.) for current holdings, from `WalletBalanceService`.      |
| **Advanced Stats Metrics**         |                         |                         | (From `AdvancedStatsAnalyzer`, in `SwapAnalysisSummary.advancedStats`)                                                                     |
| `medianPnlPerToken`                | `AdvancedStatsAnalyzer` | `AdvancedTradeStats`    | Implemented. Median PNL of non-zero PNL tokens (non-stablecoin).                                                                           |
| `trimmedMeanPnlPerToken`           | `AdvancedStatsAnalyzer` | `AdvancedTradeStats`    | Implemented. Mean PNL of non-stablecoin tokens after trimming extreme PNL values.                                                          |
| `tokenWinRatePercent`              | `AdvancedStatsAnalyzer` | `AdvancedTradeStats`    | Implemented. Percentage of non-stablecoin tokens with PNL > `WIN_THRESHOLD_SOL` among tokens with non-zero PNL. Denominator unified.        |
| `standardDeviationPnl`             | `AdvancedStatsAnalyzer` | `AdvancedTradeStats`    | Implemented. Sample standard deviation of PNLs for non-stablecoin tokens.                                                                  |
| `medianPnlToVolatilityRatio`       | `AdvancedStatsAnalyzer` | `AdvancedTradeStats`    | **Implemented** (New, Replaced `profitConsistencyIndex`). `medianPnlPerToken / standardDeviationPnl`. Measures risk-adjusted return.           |
| `weightedEfficiencyScore`          | `AdvancedStatsAnalyzer` | `AdvancedTradeStats`    | Implemented (Formula revised). Custom index based on average PNL and win rate, designed to provide a single score for PNL performance efficiency. |
| `averagePnlPerDayActiveApprox`     | `AdvancedStatsAnalyzer` | `AdvancedTradeStats`    | Implemented. Approximates PNL per day the token was actively traded. Calculated based on PNL and the duration between first/last trade of tokens. |
| `firstTransactionTimestamp (adv)`  | `AdvancedStatsAnalyzer` | `AdvancedTradeStats`    | Implemented. Earliest timestamp from trades input to `AdvancedStatsAnalyzer` (typically non-stablecoin trades).                            |
| `lastTransactionTimestamp (adv)`   | `AdvancedStatsAnalyzer` | `AdvancedTradeStats`    | Implemented. Latest timestamp from trades input to `AdvancedStatsAnalyzer` (typically non-stablecoin trades).                              |

**Behavior Analysis Focus - Updated Table**

| Metric                             | Source Analyzer/Service | Output Structure/Type | Status & Notes                                                                                                                                        |
|------------------------------------|-------------------------|-----------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Flipper Metrics**                |                         |                       | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                                                                                                       |
| `buySellRatio`                     | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Overall ratio of total buy transactions to total sell transactions. Per-token ratio inversion removed.                                     |
| `buySellSymmetry`                  | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Average buy/sell count symmetry per token for tokens that have both buy and sell activity.                                                 |
| `averageFlipDurationHours`         | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Average time in hours between a buy and its subsequent sell for completed flips.                                                           |
| `medianHoldTime`                   | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Median time in hours for buy-sell flips (holding duration).                                                                                |
| `sequenceConsistency`              | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Average ratio of actual completed buy-sell pairs to the maximum possible pairs per token.                                                  |
| `flipperScore`                     | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented (Overall ratio penalty removed). Score (0-1) indicating how much trading behavior resembles a 'flipper' style. Penalty for overall buy/sell imbalance removed. |
| **Activity Metrics**               |                         |                       | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                                                                                                       |
| `uniqueTokensTraded`               | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Count of unique token mints involved in any trade (buy or sell).                                                                           |
| `tokensWithBothBuyAndSell`         | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Count of unique tokens that have at least one buy AND at least one sell transaction.                                                       |
| `totalTradeCount`                  | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Total number of all buy and sell transactions.                                                                                             |
| `totalBuyCount`                    | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Total number of all buy transactions.                                                                                                      |
| `totalSellCount`                   | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Total number of all sell transactions.                                                                                                     |
| `completePairsCount`               | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Total number of buy-then-sell round trips (completed flips) across all tokens.                                                             |
| `averageTradesPerToken`            | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented (Zero division guarded). `totalTradeCount / uniqueTokensTraded`. Average number of trades per unique token traded.                           |
| **Time Distribution**              |                         |                       | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                                                                                                       |
| `tradingTimeDistribution`          | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Object showing percentage of flips occurring in different time buckets (e.g., <30m, 1-4h).                                                 |
| `percentTradesUnder1Hour`          | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Percentage of flips that completed in less than 1 hour.                                                                                    |
| `percentTradesUnder4Hours`         | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Percentage of flips that completed in less than 4 hours.                                                                                   |
| **Classification**                 |                         |                       | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                                                                                                       |
| `tradingStyle`                     | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Classified trading style, e.g., 'True Flipper', 'Accumulator', based on behavioral metrics.                                              |
| `confidenceScore`                  | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Confidence level (0-1) associated with the assigned `tradingStyle`.                                                                        |
| **Timestamps**                     |                         |                       | (From `BehaviorAnalyzer`, in `BehavioralMetrics`)                                                                                                       |
| `firstTransactionTimestamp`        | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Earliest timestamp from all input swap records to `BehaviorAnalyzer`.                                                                      |
| `lastTransactionTimestamp`         | `BehaviorAnalyzer`      | `BehavioralMetrics`   | Implemented. Latest timestamp from all input swap records to `BehaviorAnalyzer`.                                                                        |
| **Refined/New Behavioral Metrics** |                         |                       |                                                                                                                                                       |
| `tradingFrequency.tradesPerDay`    | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (Consistent rate logic). Average trades per day, calculated using `totalTradeCount` and duration between `firstTransactionTimestamp` and `lastTransactionTimestamp` (min 1 day or `minRateCalculationDurationDays`). |
| `tradingFrequency.tradesPerWeek`   | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (Consistent rate logic). `tradesPerDay * 7`.                                                                                            |
| `tradingFrequency.tradesPerMonth`  | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (Consistent rate logic). `tradesPerDay * 30.44` (average days per month).                                                               |
| `tokenPreferences.mostTradedTokens`| `BehaviorAnalyzer`      | `BehavioralMetrics`   | **RENAMED & Implemented** (Was `mostTraded`). List of top N token mints by total trade count (buys + sells).                                            |
| `riskMetrics.averageTransactionValueSol`| `BehaviorAnalyzer` | `BehavioralMetrics`   | **RENAMED & Implemented** (Was `averageTransactionSize`). Average SOL value of all buy/sell transactions (`sum(transaction.associatedSolValue) / totalTradeCount`). |
| `riskMetrics.largestTransactionValueSol`| `BehaviorAnalyzer`  | `BehavioralMetrics`   | **RENAMED & Implemented** (Was `largestTransaction`). Largest SOL value observed in a single transaction (`Math.max(transaction.associatedSolValue)`).   |
| `reentryRate`                      | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New). `tokensWithMultipleCycles / tokensWithBothBuyAndSell`. Measures tendency to re-trade the same token after completing a cycle. `tokensWithMultipleCycles` counts tokens with >1 buy-sell pair. |
| `percentageOfUnpairedTokens`       | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New). `((uniqueTokensTraded - tokensWithBothBuyAndSell) / uniqueTokensTraded) * 100`. Shows ratio of tokens involved in buy-only or sell-only activities. |
| `sessionCount`                     | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New). Number of distinct trading sessions, where a session is a sequence of trades with inter-trade gaps <= defined threshold (e.g., 60 mins). |
| `avgTradesPerSession`              | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New). `totalTradeCount / sessionCount`. Average number of trades within a session.                                                   |
| `activeTradingPeriods`             | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented (Refined)**. Replaced `activeHoursDistribution`. Provides structured analysis of trading activity by UTC hour, including raw counts, identified significant trading windows (start/end UTC, duration, trade count, % total trades, avg trades/hr), and an activity focus score. Uses adaptive thresholding and window merging. |
| `averageSessionStartHour`          | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New). Average start hour (0-23 UTC) of identified trading sessions, calculated using a circular mean to handle wrap-around times.        |
| `averageSessionDurationMinutes`    | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Implemented** (New). Average length of identified trading sessions in minutes.                                                                        |
| **Removed/Postponed Metrics**      |                         |                       |                                                                                                                                                       |
| `profitMetrics.*`                  | `N/A (was Behavior)`    | `BehavioralMetrics`   | **REMOVED**. All PNL-related metrics (totalPnL, winRate, etc.) removed from `BehavioralMetrics` to avoid overlap with `PnlAnalysisService`.              |
| `riskMetrics.diversificationScore` | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **REMOVED**. Deemed analytically weak without a robust definition.                                                                                      |
| `tokenPreferences.mostProfitableTokens`| `N/A (was Behavior)`| `BehavioralMetrics`   | **REMOVED**. PNL-dependent; should be derived from `PnlAnalysisService` data if needed.                                                               |
| `tokenPreferences.topNetPositiveAmountTokens`| `BehaviorAnalyzer`| `BehavioralMetrics`   | **POSTPONED/Re-evaluate**. (Was `mostHeld`). Raw net positive amount can be misleading (airdrops, junk). Requires careful thought if implemented.      |
| **Future Considerations (Volatility)**|                       |                       |                                                                                                                                                       |
| `flipDurationStandardDeviation`    | `BehaviorAnalyzer`      | `BehavioralMetrics`   | *Future Consideration*. Standard deviation of flip durations. Measures consistency in holding/flipping times.                                           |
| `tradeValueStandardDeviationSol`   | `BehaviorAnalyzer`      | `BehavioralMetrics`   | *Future Consideration*. Standard deviation of `associatedSolValue` for all trades. Measures consistency in trade sizing (SOL value).                  |
| `sessionActivityVariance`           | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Future Consideration**. Measures variance/entropy in session start times (circular std dev) or durations, quantifying regularity of session engagement. |
| `dayOfWeekActivityBias`            | `BehaviorAnalyzer`      | `BehavioralMetrics`   | **Future Consideration**. Breakdown/score of trading activity bias towards weekdays/weekends or specific days (e.g., counts per day of week).         |

---

## Phase 4: Similarity Analysis

This section covers the service responsible for analyzing behavioral and capital allocation similarities between a group of wallets.

### Services Analyzed:

1.  **`SimilarityApiService` (`src/api/analyses/similarity/similarity.service.ts`)**: Orchestrates the similarity analysis by fetching data and invoking the core analyzer.
2.  **`SimilarityAnalyzer` (`src/core/analysis/similarity/analyzer.ts`)**: Contains the core logic for calculating similarity scores, identifying shared tokens, and generating insights.

### G. `SimilarityApiService` Assessment

*   **Role**: Orchestrator.
*   **Inputs**: `walletAddresses`, `DatabaseService`.
*   **Key Operations**:
    *   Fetches necessary data for the given wallets (e.g., token holdings, balances).
    *   Invokes `SimilarityAnalyzer` to perform the analysis.
    *   Formats the analyzer's output into the `CombinedSimilarityResult` structure for the API response.
*   **Primary Output Type**: `CombinedSimilarityResult`.

### H. `SimilarityAnalyzer` Assessment

*   **Role**: Core calculation of wallet similarity based on different vectors.
*   **Inputs**: Wallet data (e.g., token vectors representing holdings or trading activity).
*   **Primary Output Type**: A detailed analysis result that includes pairwise scores and token-level details, which is then combined by the service.

### Metric Mapping Table (Similarity Analysis Focus)

| Metric                             | Source Analyzer/Service | Output Structure/Type            | Status & Notes                                                                                                                              |
|------------------------------------|-------------------------|----------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| **Overall Result Metrics**         |                         |                                  | (From `SimilarityApiService`, in `CombinedSimilarityResult`)                                                                                |
| `pairwiseSimilarities`             | `SimilarityApiService`  | `CombinedPairwiseSimilarity[]`   | **Implemented**. An array containing the detailed similarity analysis for each pair of wallets in the input set.                          |
| `walletVectorsUsed`                | `SimilarityApiService`  | `Record<string, Record<string, number>>` | **Implemented**. The actual numerical vectors used for calculation. Maps wallet address to a token vector (mint -> weight).            |
| `uniqueTokensPerWallet`            | `SimilarityApiService`  | `Record<string, { binary: number; capital: number }>` | **Implemented**. A map of wallet addresses to the count of their unique tokens under both binary and capital models.              |
| `walletBalances`                   | `SimilarityApiService`  | `Record<string, { tokenBalances: { mint: string }[] }>` | **Implemented (Optional)**. May contain the token balances for each wallet, used as the basis for capital analysis.                |
| `vectorTypeUsed`                   | `SimilarityApiService`  | `'combined'`                     | **Implemented**. Indicates that the result combines both binary and capital analysis.                                                       |
| **Pairwise Similarity Metrics**    |                         |                                  | (In `CombinedPairwiseSimilarity`, part of `CombinedSimilarityResult.pairwiseSimilarities`)                                                  |
| `walletA` / `walletB`              | `SimilarityAnalyzer`    | `string`                         | **Implemented**. The two wallet addresses being compared in this pair.                                                                      |
| `binaryScore`                      | `SimilarityAnalyzer`    | `number`                         | **Implemented**. The similarity score (e.g., Jaccard index or Cosine Similarity) based on shared token *presence* (binary vector).          |
| `capitalScore`                     | `SimilarityAnalyzer`    | `number`                         | **Implemented**. The similarity score (e.g., Cosine Similarity) based on shared token *and* capital allocation (capital-weighted vector). |
| `sharedTokens`                     | `SimilarityAnalyzer`    | `string[]`                       | **Implemented**. A simple list of mints that are shared between the two wallets. This is now an array of strings.                                                                       |
| `capitalAllocation`                | `SimilarityAnalyzer`    | `Record<string, { weightA: number; weightB: number }>` | **Implemented**. For shared tokens, shows the capital allocation (weight/percentage) for each wallet in the pair.                     |
| `binarySharedTokenCount`           | `SimilarityAnalyzer`    | `number`                         | **Implemented**. The number of unique tokens shared between Wallet A and Wallet B.                                                          |
| `binaryUniqueTokenCountA`          | `SimilarityAnalyzer`    | `number`                         | **Implemented**. The number of unique tokens held by Wallet A but not Wallet B.                                                             |
| `binaryUniqueTokenCountB`          | `SimilarityAnalyzer`    | `number`                         | **Implemented**. The number of unique tokens held by Wallet B but not Wallet A.                                                             |
| `capitalSharedTokenCount`          | `SimilarityAnalyzer`    | `number`                         | **Implemented**. The number of shared tokens considered in the capital allocation analysis.                                                  |
| `capitalUniqueTokenCountA`         | `SimilarityAnalyzer`    | `number`                         | **Implemented**. The number of unique tokens with capital allocation for Wallet A but not Wallet B.                                       |
| `capitalUniqueTokenCountB`         | `SimilarityAnalyzer`    | `number`                         | **Implemented**. The number of unique tokens with capital allocation for Wallet B but not Wallet A.                                       |
