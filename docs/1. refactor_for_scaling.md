# Wallet Analysis System Refactoring Implementation Plan (Revised)

**Status Update (as of current conversation):** Core logic extraction is largely complete for Behavior, Correlation, and Similarity analysis. PNL calculation is moved to utils. Bot filtering and Shared Token analysis are integrated into Correlation and Similarity services respectively. Reporting Service handles report generation. The next major step is transforming the scripts in `src/scripts/` to *use* these services.

## Phase 1: Core Analysis Logic Extraction (Complete for Behavior/Correlation/Similarity)

### 1.1 Reorganize Existing Types (Complete)
Location: `src/types/`
- Types are consolidated in `analysis.ts`, `behavior.ts`, `correlation.ts`, `similarity.ts`, `wallet.ts`, etc.

### 1.2 Extract Core Analysis Logic (Complete for Behavior/Correlation/Similarity)

#### 1.2.1 Correlation Analysis
Location: `src/wallet_analysis/core/correlation/analyzer.ts`
- `CorrelationAnalyzer` class encapsulates pairwise scoring, clustering, and global token stats calculation, migrated from `activityCorrelator.ts`.

#### 1.2.2 Behavior Analysis
Location: `src/wallet_analysis/core/behavior/analyzer.ts`
- `BehaviorAnalyzer` class encapsulates sequence building, metrics calculation, and classification, migrated from `wallet-behavior-analyzer.ts`.

#### 1.2.3 Similarity Analysis
Location: `src/wallet_analysis/core/similarity/analyzer.ts`
- `SimilarityAnalyzer` class encapsulates vector creation (capital/binary) and similarity scoring (cosine), migrated from `walletSimilarity.ts`.

#### 1.2.4 KPI Reporting Analysis
Location: `src/wallet_analysis/core/reporting/kpi_analyzer.ts`
- `KPIComparisonAnalyzer` encapsulates comparative report generation logic from `kpi-comparison-report.ts`.

### 1.3 Extract Utility Functions (Complete)

#### 1.3.1 PNL Calculation
Location: `src/wallet_analysis/utils/pnl_calculator.ts`
- Contains `calculateWalletPnl` and `calculatePnlForWallets`, extracted from `activityCorrelator.ts`.

#### 1.3.2 Reporting Utilities
Location: `src/wallet_analysis/reporting/report_utils.ts`
- Contains `generateBehaviorReport`, `generateCorrelationReport`, `generateSimilarityReport`, and `saveReport`, consolidating logic from multiple scripts.

## Phase 2: Service Layer Enhancement (Complete for Behavior/Correlation/Similarity/Reporting)

### 2.1 Analysis Services
Location: `src/wallet_analysis/services/`

#### 2.1.1 `CorrelationService`
- Uses `CorrelationAnalyzer`.
- Integrates database fetching (via `DatabaseService`).
- Integrates bot filtering logic (from `activityCorrelator.ts`).
- Integrates PNL calculation (using `pnl_calculator.ts`).

#### 2.1.2 `BehaviorService`
- Uses `BehaviorAnalyzer`.
- Integrates database fetching (via `DatabaseService`).

#### 2.1.3 `SimilarityService`
- Uses `SimilarityAnalyzer`.
- Integrates database fetching (via `DatabaseService`).
- Integrates shared token analysis (from `walletSimilarity.ts`).

#### 2.1.4 `ReportingService`
- Uses `BehaviorService`, `CorrelationService` (optional), `SimilarityService` (optional), `KPIComparisonAnalyzer`.
- Uses `report_utils.ts` to generate and save various report types (individual behavior, comparative behavior, correlation, similarity).

### 2.2 Enhance Existing Services (Ongoing)

- `DatabaseService`: Refactored into a class. Imports in older scripts like `helius-analyzer.ts` need updating.
- `HeliusApiClient`: Assumed functional based on plan.
- `HeliusTransactionMapper`: Assumed functional based on plan.

## Phase 3: Script Refactoring (Ongoing)

**Goal:** Transform scripts in `src/scripts/` to act as simple orchestrators or entry points that primarily call the new services.

### 3.1 `activityCorrelator.ts`
- **Status: Complete**
- The script now handles CLI argument parsing (wallet source, excludeMints, timeRange).
- It instantiates `DatabaseService`, `CorrelationService`, and `ReportingService`.
- It creates `CorrelationAnalysisConfig` with CLI args.
- It calls `reportingService.generateAndSaveCorrelationReport` to orchestrate the analysis and reporting.
- Internal logic for fetching, filtering, PNL calculation, analysis, clustering, and report generation has been removed.

### 3.2 `wallet-behavior-analyzer.ts`
- **Status: Complete** 
- The script now handles CLI argument parsing (walletAddress, label, excludeMints, timeRange).
- It instantiates `DatabaseService`, `BehaviorService`, and `ReportingService`.
- It creates `BehaviorAnalysisConfig` with CLI args.
- It calls `behaviorService.analyzeWalletBehavior`.
- It calls `reportingService.generateAndSaveIndividualBehaviorReport`.
- Internal logic for fetching, analysis, and reporting has been removed.

### 3.3 `kpi-comparison-report.ts`
- **Status: Complete** 
- The script now handles CLI argument parsing (walletList file, excludeMints, timeRange).
- It instantiates `DatabaseService`, `BehaviorService`, `KPIComparisonAnalyzer`, and `ReportingService`.
- It creates `BehaviorAnalysisConfig` with CLI args.
- It calls `reportingService.generateComparativeBehaviorReport`.
- Internal logic for fetching, analysis, and reporting has been removed.

### 3.4 `walletSimilarity.ts`
- **To Do:** Update `main` function to:
    - Parse CLI args (wallet source, vector type, potentially timeRange/excludeMints).
    - Instantiate `DatabaseService` and `SimilarityService`.
    - Create `SimilarityAnalysisConfig` (potentially including timeRange/excludeMints).
    - Instantiate `ReportingService` (injecting `SimilarityService`).
    - Call `reportingService.generateAndSaveSimilarityReport(walletAddresses, vectorType)`.
    - Remove internal logic for fetching, shared token analysis, vector creation, similarity calc, and reporting.

### 3.5 `helius-analyzer.ts` (Deferred)
- Requires significant refactoring to extract swap analysis, advanced stats calculation, and complex fetch logic into core modules/services before the script itself can be simplified.

## Phase 4: API Layer Preparation (Future)

- Remains unchanged from the original plan. API interfaces can be built on top of the service layer.

## Implementation Order (Updated)

1.  Type Consolidation (Done)
2.  Core Analysis Extraction (Done for Behavior/Correlation/Similarity)
3.  Utility Function Extraction (Done for PNL/Reporting)
4.  Service Implementation (Done for Behavior/Correlation/Similarity/Reporting)
5.  Configuration Type Refactoring (Done)
6.  **Script Transformation (In Progress - `activityCorrelator.ts`, `wallet-behavior-analyzer.ts`, `kpi-comparison-report.ts` Done)**
    - Update scripts one by one to use the new services.
    - Verify functionality.
    - Update tests.
7.  Refactor `walletSimilarity.ts` (Next)
8.  Helius Analyzer Refactoring (Deferred)
9.  API Layer Implementation (Future)

## Testing Strategy (Unchanged)

- Unit Tests for core analyzers and utils.
- Integration Tests for services.
- End-to-End Tests for script execution flows.

## Migration Strategy (Unchanged)

- Gradual migration recommended.
- Feature flags if needed.
- Monitoring.
