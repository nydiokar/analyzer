docker run -d -p 6379:6379 redis:latest  

3 tasks:


### Strategic Refactoring Plan: Hybrid "Grid + Detail" UI for Pairwise Analysis

This document outlines the comprehensive plan to refactor the `EnhancedKeyInsights` component. The goal is to move from the current single-feed layout to a more robust, intuitive, and scalable "Grid + Detail" hybrid model, incorporating best practices and addressing all known issues.

---

#### 1. Guiding Principles & Goals

*   **Holistic Improvement:** This is more than a style change. We will improve UI, UX, data presentation, performance, and code structure simultaneously.
*   **Clarity over Density:** We will preserve all existing information but present it in a way that avoids cognitive overload. The user should be able to scan for insights and dive deep without friction.
*   **Scalability & Performance:** The new design must perform well whether there are 5 pairs or 50, using virtualization and optimized rendering.
*   **Consistency & Maintainability:** We will create a clean component structure and adhere to consistent design tokens (colors, icons, fonts) to make future development easier.

---

#### 2. Potential Challenges & Mitigations (Traps to Avoid)

| Challenge | Mitigation Strategy |
| :--- | :--- |
| **State Management** | Keep state management at the top `EnhancedKeyInsights` level. Use a simple `selectedPairId: string | null` state. The ID can be a concatenation of the two wallet addresses (e.g., `walletA-walletB`). |
| **Responsive Design** | On large screens, use a side-by-side grid/detail layout (e.g., 7/5 column split). On mobile/smaller screens, the layout will stack vertically, with the Detail panel appearing below the Grid. |
| **Component Structure** | Adhere to a clean three-level hierarchy: `EnhancedKeyInsights` (Controller) -> `PairGrid` & `PairDetail` (Views). This avoids excessive prop drilling while keeping logic contained. |
| **Data Integrity** | Add a development-only check to warn if the wallet list used to generate pairs differs from other wallet lists in the props. This flags potential upstream data mismatches as noted in your document. |

---

#### 3. The Execution Blueprint (The "How")

This is a phased approach to implementation.

##### **Phase 1: Component Structuring & Layout**

1.  **Main Component (`EnhancedKeyInsights`):**
    *   **Layout:** Rework the root element into a responsive 12-column CSS grid.
    *   **State:** Introduce `const [selectedPairId, setSelectedPairId] = useState<string | null>(null);`. On initial load and after any sort, set `selectedPairId` to the ID of the *first* pair in the list so the detail view is never empty.
    *   **Data Logic:** Keep the existing `useMemo` hooks for data processing. They will now feed props into the new child components.

2.  **Master View (`PairGrid` component):**
    *   **Purpose:** Display the scrollable, high-level overview of all wallet pairs.
    *   **Props:** Receives `pairs`, `selectedPairId`, `onSelectPair`.
    *   **Virtualization:** To handle a large number of pairs gracefully, this grid will be built using a virtualization library like `react-window` or `react-virtual`.
    *   **Child Component (`PairCard`):**
        *   **Content:** A compact, fixed-height card showing only essential data: Wallet A ↔ Wallet B, the primary score (Behavioral or Capital), and an icon for the insight type. Use `<Progress>` for the score bars for a clean look.
        *   **Interaction:** `onClick` triggers the `onSelectPair` callback. The card will have a distinct visual style (e.g., border color) when its ID matches `selectedPairId`.

3.  **Detail View (`PairDetail` component):**
    *   **Purpose:** Display the rich, detailed breakdown for a single selected pair.
    *   **Props:** Receives `pairData`.
    *   **Conditional Rendering:** If `pairData` is null, it shows an empty state encouraging the user to select a pair.
    *   **Content (Always Expanded):**
        *   The full `insight.text`.
        *   Detailed `ScoreBar` breakdowns for both Behavioral and Capital scores.
        *   The **Top 10 Shared Tokens table**, now always visible without needing to be expanded.
        *   **Table Pagination:** The tokens table will be paginated (e.g., 5-10 rows per page) to handle cases with many shared tokens cleanly.

##### **Phase 2: Visual Polish & Consistency**

1.  **Iconography:** Systematically replace all hard-coded/emoji icons with the appropriate `lucide-react` icons as mapped in your notes (`LinkIcon`, `Handshake`, `Scale`, etc.).
2.  **Color & Typography:**
    *   Standardize insight badges to use the specified semantic color system (e.g., `bg-red-100 text-red-800 border-red-200`) for accessibility and visual consistency.
    *   Enforce the rule: `font-mono` is used *only* for wallet addresses and token mints. All other text uses the default sans-serif font.
3.  **Loading States:** Replace all text-based loading indicators with `Skeleton` components for a modern, professional feel. The `PairGrid` and `PairDetail` sections should have their own skeleton layouts.
4.  **Interactive Elements:** Fix the `WalletBadge` to be a proper `<Button>` with an `onCopy` action. An external link icon can be placed next to it, removing the invalid nested `<a>` tag.


---

#### 4. How We Preserve Information & Functionality

*   **No Data Loss:** Every piece of data from the original design is retained. It is simply redistributed between the summary `PairCard` and the comprehensive `PairDetail` view.
*   **Sorting Retained:** The "Sort by Behavioral / Capital" `Tabs` will remain in place and will re-order the virtualized `PairGrid` as expected.
*   **Functionality Enhanced:** Usability is significantly improved by removing the unstable accordion, eliminating nested scrolling, and providing a clear, predictable layout for exploration and comparison.

This plan creates a clear path to a vastly improved component that is both more powerful for the user and more robust under the hood.



1. Check debugging for the capital allocation

2. compare the ui imporvements from o3:

Especially: 

- distribution sparkline to replace current ugly bar chart
- drill-down  hover on score bar reveals per-token weight contribution; optional PCA scatterplot. Instead of current implementation in key insights

Adopt three-tier information hierarchy.

Structural inconsistencies
• ✅ EnhancedKeyInsights expects results.walletVectorsUsed but server payload in page.tsx may not guarantee that key. Guard it.
• ✅ ScoreBar width calculation lacks clamp; score > 1 renders bar off‐bounds.
• ✅ capitalOverlapPctA/B are computed from fractional weights then multiplied by 100; sum of many shared tokens can exceed 100 → misleading percentages.
• ✅ WalletBadge uses inline button inside anchor; nested interactive elements violate HTML spec and cause accessibility errors.
• ❌ Emojis mixed with lucide-react icons create style drift.
• ✅ Hard-coded h-[700px] scroll area in EnhancedKeyInsights breaks on small screens.
• ❌ Duplicate addresses filtered in page.tsx but EnhancedKeyInsights still uses unfiltered results; possible mismatch if backend rejects duplicates differently.

Presentation overhaul directives
Layout

❌ 12-column CSS grid:
 • col-span-8 → "Key Insights & Pairwise Deep-Dive".
 • col-span-4 → "Most Common Tokens" + global metrics.
 • ❌ sticky top toolbar (wallet input, analyze button, sync status).

❌ Inside "Key Insights" replace vertical card stack with virtualized list (react-window). Maintain scroll-sync with token panel.

❌ Collapse each pair into a single-line summary row; click to reveal detailed token table (reuse shadcn Accordion).

Visual hierarchy
❌ 4. Replace emojis with lucide icons:
 VeryHighSimilarity → LinkIcon
 SustainedAlignment → Handshake
 SignificantAsymmetry → Scales
 BehavioralMirror → Users2
 CapitalDivergence → ArrowUpRightFromSquare
 SharedZeroHoldings → Ban
❌ 5. Color system: use Tailwind semantic tokens; insight badge bg-{color}-100 text-{color}-800 border-{color}-200 for WCAG contrast.
❌ 6. Use font-mono only for addresses and mints; everywhere else default Sans.

Data density
❌ 7. Default view shows:
 walletA | walletB | BehavioralScore | CapitalScore | InsightType
 Scores rendered with <Progress value={score*100} max={100}/> inside 96-px bar.
❌ 8. Detailed view tables paginated (PageSize=10) with column freeze on token mint.
❌ 9. Global summary card above lists:
 Total wallets analysed, pairs > 0.5 behavioral, pairs > 0.5 capital, top token frequency histogram.

Interaction
❌ 10. WalletBadge becomes <Button variant="ghost" size="sm"> with onCopy; external link moved to icon button placed after badge to avoid nested click targets.
❌ 11. Add <Input type="file"> to accept CSV of wallets; parse client-side.
❌ 12. Use Skeleton components for loading state instead of "Analyzing…".

Accessibility & performance
✅ 13. aria-labels on icons, buttons, accordions.
❌ 14. Prefer next/image for token logos when metadata ready; set width/height to avoid CLS.
✅ 15. Memoize heavy calculations (capitalOverlap) with useMemo keyed by sharedTokens.length


